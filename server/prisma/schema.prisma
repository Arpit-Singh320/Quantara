// Quantara Database Schema
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USER & AUTH ============

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String
  company       String?
  role          UserRole  @default(BROKER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  connections   Connection[]
  auditLogs     AuditLog[]
  clients       Client[]
  policies      Policy[]
  renewals      Renewal[]
  chatSessions  ChatSession[]
  calendarEvents CalendarEvent[]

  @@map("users")
}

enum UserRole {
  ADMIN
  BROKER
  VIEWER
}

// ============ OAUTH CONNECTIONS ============

model Connection {
  id            String          @id @default(uuid())
  userId        String
  type          ConnectionType
  accessToken   String          // Encrypted
  refreshToken  String?         // Encrypted
  expiresAt     DateTime?
  scopes        String[]
  metadata      Json?
  lastSyncAt    DateTime?
  status        ConnectionStatus @default(ACTIVE)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  syncLogs      SyncLog[]

  @@unique([userId, type])
  @@map("connections")
}

enum ConnectionType {
  SALESFORCE
  MICROSOFT
  GOOGLE
  HUBSPOT
  APPLIED_EPIC
  VERTAFORE
}

enum ConnectionStatus {
  ACTIVE
  EXPIRED
  REVOKED
  ERROR
}

model SyncLog {
  id            String      @id @default(uuid())
  connectionId  String
  status        SyncStatus
  recordsSync   Int         @default(0)
  errorMessage  String?
  startedAt     DateTime    @default(now())
  completedAt   DateTime?

  // Relations
  connection    Connection  @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@map("sync_logs")
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============ CLIENTS ============

model Client {
  id            String      @id @default(uuid())
  userId        String
  externalId    String?     // ID from CRM
  name          String
  company       String
  email         String?
  phone         String?
  industry      String?
  address       Json?
  metadata      Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  policies      Policy[]
  renewals      Renewal[]
  contacts      Contact[]
  activities    Activity[]
  calendarEvents CalendarEvent[]

  @@unique([userId, externalId])
  @@map("clients")
}

model Contact {
  id            String      @id @default(uuid())
  clientId      String
  name          String
  email         String?
  phone         String?
  title         String?
  isPrimary     Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  client        Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("contacts")
}

// ============ POLICIES ============

model Policy {
  id              String        @id @default(uuid())
  userId          String
  clientId        String
  externalId      String?
  policyNumber    String
  type            PolicyType
  carrier         String
  premium         Decimal       @db.Decimal(12, 2)
  coverageLimit   Decimal       @db.Decimal(14, 2)
  deductible      Decimal?      @db.Decimal(12, 2)
  effectiveDate   DateTime
  expirationDate  DateTime
  status          PolicyStatus  @default(ACTIVE)
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  renewals        Renewal[]

  @@unique([userId, policyNumber])
  @@map("policies")
}

enum PolicyType {
  GENERAL_LIABILITY
  PROFESSIONAL_LIABILITY
  CYBER_LIABILITY
  WORKERS_COMPENSATION
  PROPERTY
  AUTO
  UMBRELLA
  DIRECTORS_OFFICERS
  EMPLOYMENT_PRACTICES
  OTHER
}

enum PolicyStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

// ============ RENEWALS ============

model Renewal {
  id              String        @id @default(uuid())
  userId          String
  clientId        String
  policyId        String
  dueDate         DateTime
  status          RenewalStatus @default(PENDING)
  riskScore       RiskLevel     @default(MEDIUM)
  riskFactors     String[]
  aiSummary       String?
  aiInsights      String[]
  priority        Int           @default(0)
  assignedTo      String?

  // Source tracking for connector compliance
  sourceSystem    String?       // e.g., "Salesforce CRM", "CSV Import", "Quantara"
  sourceRecordId  String?       // External system record ID
  sourceLink      String?       // Direct link to source record

  // Metrics
  emailsSent      Int           @default(0)
  quotesReceived  Int           @default(0)
  lastTouchedAt   DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  completedAt     DateTime?

  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  policy          Policy        @relation(fields: [policyId], references: [id], onDelete: Cascade)
  activities      Activity[]
  quotes          Quote[]
  tasks           Task[]
  documents       Document[]
  calendarEvents  CalendarEvent[]

  @@map("renewals")
}

enum RenewalStatus {
  PENDING
  IN_PROGRESS
  QUOTED
  BOUND
  LOST
  CANCELLED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

model Quote {
  id              String      @id @default(uuid())
  renewalId       String
  carrier         String
  premium         Decimal     @db.Decimal(12, 2)
  coverageLimit   Decimal     @db.Decimal(14, 2)
  deductible      Decimal?    @db.Decimal(12, 2)

  // Extended coverage details for comparison
  perOccurrence   Decimal?    @db.Decimal(14, 2)
  aggregate       Decimal?    @db.Decimal(14, 2)
  coinsurance     Int?        // Percentage
  waitingPeriod   Int?        // Days
  retroactiveDate DateTime?

  // Coverage specifics (JSON for flexibility)
  coverages       Json?       // Array of coverage items with limits
  exclusions      String[]    // Notable exclusions
  endorsements    String[]    // Included endorsements

  // Comparison metrics
  priceChange     Decimal?    @db.Decimal(5, 2)  // % change from expiring
  coverageScore   Int?        // 1-100 AI-rated coverage quality
  recommendation  String?     // AI recommendation text

  terms           Json?
  notes           String?
  status          QuoteStatus @default(PENDING)
  isSelected      Boolean     @default(false)
  receivedAt      DateTime    @default(now())
  expiresAt       DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  renewal         Renewal     @relation(fields: [renewalId], references: [id], onDelete: Cascade)
  documents       Document[]

  @@index([renewalId, status])
  @@map("quotes")
}

enum QuoteStatus {
  PENDING
  RECEIVED
  SELECTED
  REJECTED
  EXPIRED
}

// ============ ACTIVITIES ============

model Activity {
  id            String        @id @default(uuid())
  clientId      String?
  renewalId     String?
  type          ActivityType
  title         String
  description   String?
  metadata      Json?
  occurredAt    DateTime      @default(now())
  createdAt     DateTime      @default(now())

  // Relations
  client        Client?       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  renewal       Renewal?      @relation(fields: [renewalId], references: [id], onDelete: Cascade)

  @@map("activities")
}

enum ActivityType {
  EMAIL_SENT
  EMAIL_RECEIVED
  EMAIL_SCHEDULED
  CALL_MADE
  CALL_RECEIVED
  MEETING_SCHEDULED
  MEETING_COMPLETED
  QUOTE_REQUESTED
  QUOTE_RECEIVED
  DOCUMENT_UPLOADED
  NOTE_ADDED
  STATUS_CHANGED
}

// ============ AI CHAT ============

model ChatSession {
  id            String        @id @default(uuid())
  userId        String
  title         String?
  context       Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id            String      @id @default(uuid())
  sessionId     String
  role          ChatRole
  content       String
  sources       Json?
  metadata      Json?
  createdAt     DateTime    @default(now())

  // Relations
  session       ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

// ============ TASKS & WORKFLOW ============

model Task {
  id            String      @id @default(uuid())
  renewalId     String
  name          String
  description   String?
  dueDate       DateTime
  status        TaskStatus  @default(PENDING)
  priority      Priority    @default(MEDIUM)
  category      TaskCategory @default(OTHER)
  assignedToId  String?
  completedAt   DateTime?
  completedById String?
  order         Int         @default(0)
  isTemplate    Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  renewal       Renewal     @relation(fields: [renewalId], references: [id], onDelete: Cascade)

  @@index([renewalId, status])
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
  SKIPPED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskCategory {
  DATA_COLLECTION
  MARKETING
  QUOTE_FOLLOW_UP
  CLIENT_COMMUNICATION
  PROPOSAL
  BINDING
  POST_BIND
  OTHER
}

// Task templates for auto-creating checklists
model TaskTemplate {
  id            String      @id @default(uuid())
  userId        String?     // null = system template
  name          String
  description   String?
  policyType    PolicyType?
  category      TaskCategory @default(OTHER)
  daysBeforeDue Int         // Relative to renewal due date
  priority      Priority    @default(MEDIUM)
  order         Int         @default(0)
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("task_templates")
}

// ============ DOCUMENTS ============

model Document {
  id            String        @id @default(uuid())
  userId        String
  clientId      String?
  policyId      String?
  renewalId     String?
  quoteId       String?

  name          String
  originalName  String
  type          DocumentType
  mimeType      String
  size          Int           // bytes
  storageKey    String        // S3/R2 key
  storageUrl    String?       // Public URL if applicable

  version       Int           @default(1)
  parentId      String?       // For version control

  metadata      Json?
  extractedText String?       // OCR/parsed content

  uploadedAt    DateTime      @default(now())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  renewal       Renewal?      @relation(fields: [renewalId], references: [id], onDelete: Cascade)
  quote         Quote?        @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@index([clientId])
  @@index([policyId])
  @@index([renewalId])
  @@map("documents")
}

enum DocumentType {
  POLICY
  QUOTE
  LOSS_RUN
  APPLICATION
  CERTIFICATE
  ENDORSEMENT
  INVOICE
  CLAIM
  CORRESPONDENCE
  OTHER
}

// ============ CALENDAR EVENTS ============

model CalendarEvent {
  id          String            @id @default(uuid())
  userId      String
  title       String
  description String?
  type        CalendarEventType @default(MEETING)
  date        DateTime
  time        String            // HH:mm format
  duration    Int               @default(60) // minutes
  location    String?
  clientId    String?
  renewalId   String?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  client      Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  renewal     Renewal?          @relation(fields: [renewalId], references: [id], onDelete: SetNull)

  @@index([userId, date])
  @@index([clientId])
  @@map("calendar_events")
}

enum CalendarEventType {
  MEETING
  CALL
  RENEWAL
  DEADLINE
}

// ============ AUDIT LOGS ============

model AuditLog {
  id            String      @id @default(uuid())
  userId        String?
  action        String
  resource      String
  resourceId    String?
  details       Json?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime    @default(now())

  // Relations
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([resource, resourceId])
  @@map("audit_logs")
}
