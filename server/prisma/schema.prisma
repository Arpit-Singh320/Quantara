// Quantara Database Schema
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USER & AUTH ============

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String
  company       String?
  role          UserRole  @default(BROKER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  connections   Connection[]
  auditLogs     AuditLog[]
  clients       Client[]
  policies      Policy[]
  renewals      Renewal[]
  chatSessions  ChatSession[]

  @@map("users")
}

enum UserRole {
  ADMIN
  BROKER
  VIEWER
}

// ============ OAUTH CONNECTIONS ============

model Connection {
  id            String          @id @default(uuid())
  userId        String
  type          ConnectionType
  accessToken   String          // Encrypted
  refreshToken  String?         // Encrypted
  expiresAt     DateTime?
  scopes        String[]
  metadata      Json?
  lastSyncAt    DateTime?
  status        ConnectionStatus @default(ACTIVE)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  syncLogs      SyncLog[]

  @@unique([userId, type])
  @@map("connections")
}

enum ConnectionType {
  SALESFORCE
  MICROSOFT
  GOOGLE
  HUBSPOT
  APPLIED_EPIC
  VERTAFORE
}

enum ConnectionStatus {
  ACTIVE
  EXPIRED
  REVOKED
  ERROR
}

model SyncLog {
  id            String      @id @default(uuid())
  connectionId  String
  status        SyncStatus
  recordsSync   Int         @default(0)
  errorMessage  String?
  startedAt     DateTime    @default(now())
  completedAt   DateTime?

  // Relations
  connection    Connection  @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@map("sync_logs")
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============ CLIENTS ============

model Client {
  id            String      @id @default(uuid())
  userId        String
  externalId    String?     // ID from CRM
  name          String
  company       String
  email         String?
  phone         String?
  industry      String?
  address       Json?
  metadata      Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  policies      Policy[]
  renewals      Renewal[]
  contacts      Contact[]
  activities    Activity[]

  @@unique([userId, externalId])
  @@map("clients")
}

model Contact {
  id            String      @id @default(uuid())
  clientId      String
  name          String
  email         String?
  phone         String?
  title         String?
  isPrimary     Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  client        Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("contacts")
}

// ============ POLICIES ============

model Policy {
  id              String        @id @default(uuid())
  userId          String
  clientId        String
  externalId      String?
  policyNumber    String
  type            PolicyType
  carrier         String
  premium         Decimal       @db.Decimal(12, 2)
  coverageLimit   Decimal       @db.Decimal(14, 2)
  deductible      Decimal?      @db.Decimal(12, 2)
  effectiveDate   DateTime
  expirationDate  DateTime
  status          PolicyStatus  @default(ACTIVE)
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  renewals        Renewal[]

  @@unique([userId, policyNumber])
  @@map("policies")
}

enum PolicyType {
  GENERAL_LIABILITY
  PROFESSIONAL_LIABILITY
  CYBER_LIABILITY
  WORKERS_COMPENSATION
  PROPERTY
  AUTO
  UMBRELLA
  DIRECTORS_OFFICERS
  EMPLOYMENT_PRACTICES
  OTHER
}

enum PolicyStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

// ============ RENEWALS ============

model Renewal {
  id              String        @id @default(uuid())
  userId          String
  clientId        String
  policyId        String
  dueDate         DateTime
  status          RenewalStatus @default(PENDING)
  riskScore       RiskLevel     @default(MEDIUM)
  riskFactors     String[]
  aiSummary       String?
  aiInsights      String[]
  priority        Int           @default(0)
  assignedTo      String?

  // Metrics
  emailsSent      Int           @default(0)
  quotesReceived  Int           @default(0)
  lastTouchedAt   DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  completedAt     DateTime?

  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  policy          Policy        @relation(fields: [policyId], references: [id], onDelete: Cascade)
  activities      Activity[]
  quotes          Quote[]

  @@map("renewals")
}

enum RenewalStatus {
  PENDING
  IN_PROGRESS
  QUOTED
  BOUND
  LOST
  CANCELLED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

model Quote {
  id            String      @id @default(uuid())
  renewalId     String
  carrier       String
  premium       Decimal     @db.Decimal(12, 2)
  coverageLimit Decimal     @db.Decimal(14, 2)
  deductible    Decimal?    @db.Decimal(12, 2)
  terms         Json?
  status        QuoteStatus @default(PENDING)
  receivedAt    DateTime    @default(now())
  expiresAt     DateTime?

  // Relations
  renewal       Renewal     @relation(fields: [renewalId], references: [id], onDelete: Cascade)

  @@map("quotes")
}

enum QuoteStatus {
  PENDING
  RECEIVED
  SELECTED
  REJECTED
  EXPIRED
}

// ============ ACTIVITIES ============

model Activity {
  id            String        @id @default(uuid())
  clientId      String?
  renewalId     String?
  type          ActivityType
  title         String
  description   String?
  metadata      Json?
  occurredAt    DateTime      @default(now())
  createdAt     DateTime      @default(now())

  // Relations
  client        Client?       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  renewal       Renewal?      @relation(fields: [renewalId], references: [id], onDelete: Cascade)

  @@map("activities")
}

enum ActivityType {
  EMAIL_SENT
  EMAIL_RECEIVED
  CALL_MADE
  CALL_RECEIVED
  MEETING_SCHEDULED
  MEETING_COMPLETED
  QUOTE_REQUESTED
  QUOTE_RECEIVED
  DOCUMENT_UPLOADED
  NOTE_ADDED
  STATUS_CHANGED
}

// ============ AI CHAT ============

model ChatSession {
  id            String        @id @default(uuid())
  userId        String
  title         String?
  context       Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id            String      @id @default(uuid())
  sessionId     String
  role          ChatRole
  content       String
  sources       Json?
  metadata      Json?
  createdAt     DateTime    @default(now())

  // Relations
  session       ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

// ============ AUDIT LOGS ============

model AuditLog {
  id            String      @id @default(uuid())
  userId        String?
  action        String
  resource      String
  resourceId    String?
  details       Json?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime    @default(now())

  // Relations
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([resource, resourceId])
  @@map("audit_logs")
}
